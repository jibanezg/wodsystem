<div class="wizard-step step-advantages">
  <div class="step-header">
    <h3><i class="fas fa-star"></i> {{i18n 'Wizard.Advantages'}}</h3>
    <p class="step-description">{{i18n 'Wizard.SelectAdvantages'}}{{#if (or (eq actorType "Technocrat") (eq actorType "Mage"))}} {{i18n 'Wizard.IncludingSpheres'}}{{/if}}.</p>
  </div>

  <div class="step-body">
    <div class="advantages-grid">
      
      <!-- Backgrounds -->
      <div class="advantage-section">
        <h4>{{i18n 'Advantages.Backgrounds'}} ({{config.advantages.backgrounds.points}} {{i18n 'Wizard.Points'}})</h4>
        {{#if config.advantages.backgrounds.doubleCost}}
        <p class="note double-cost-note">
          <i class="fas fa-exclamation-triangle"></i>
          <strong>{{#each config.advantages.backgrounds.doubleCost}}{{this}}{{#unless @last}}, {{/unless}}{{/each}}</strong> {{i18n 'Wizard.Cost2PointsPerDot'}}
        </p>
        {{/if}}
        
        {{#if validation.backgrounds}}
        <div class="points-tracker">
          <span class="spent">{{validation.backgrounds.spent}}</span> / 
          <span class="allowed">{{validation.backgrounds.allowed}}</span> {{i18n 'Wizard.PointsSpent'}}
          {{#if (gt validation.backgrounds.remaining 0)}}
          <span class="remaining">({{validation.backgrounds.remaining}} {{i18n 'Wizard.Remaining'}})</span>
          {{/if}}
        </div>
        {{/if}}
        
        <div class="backgrounds-list">
          {{#each wizardData.advantages.backgrounds}}
          <div class="background-item" data-background-name="{{name}}">
            <select class="background-select" data-index="{{@index}}">
              <option value="">{{i18n 'Wizard.SelectLabel'}} {{i18n 'Advantages.Backgrounds'}} --</option>
              {{#each @root.backgroundsList}}
              <option value="{{this}}" {{#if (eq this ../name)}}selected{{/if}}>{{this}}</option>
              {{/each}}
            </select>
            {{#if name}}
            <button type="button" class="background-reference-btn" data-background-name="{{name}}" title="{{i18n 'Wizard.ViewBackgroundDetails' name=name}}">
              <i class="fas fa-book"></i>
            </button>
            {{/if}}
            <div class="background-controls">
              <button type="button" class="bg-decrease" data-index="{{@index}}" {{#if (eq (default value 0) 0)}}disabled{{/if}}>
                <i class="fas fa-minus"></i>
              </button>
              <span class="bg-value">{{default value 0}}</span>
              <button type="button" class="bg-increase" data-index="{{@index}}" {{#if (or (eq (default value 0) @root.config.advantages.backgrounds.maxPerBackground) (and @root.validation.backgrounds (lte @root.validation.backgrounds.remaining 0)))}}disabled{{/if}}>
                <i class="fas fa-plus"></i>
              </button>
            </div>
            <div class="background-dots">
              {{{renderDots (default value 0) @root.config.advantages.backgrounds.maxPerBackground}}}
            </div>
            <button type="button" class="remove-background" data-index="{{@index}}">
              <i class="fas fa-trash"></i>
            </button>
          </div>
          {{/each}}
        </div>
        
        <button type="button" class="add-background">
          <i class="fas fa-plus"></i> {{i18n 'Backgrounds.AddBackground'}}
        </button>
      </div>

      <!-- Enlightenment (Technocrat and Mage) -->
      {{#if (or (eq actorType "Technocrat") (eq actorType "Mage"))}}
      <div class="advantage-section enlightenment-section">
        <h4>{{i18n 'Advantages.Enlightenment'}} (Arete)</h4>
        <div class="enlightenment-info">
          <p>{{i18n 'Wizard.StartingEnlightenment'}}: <strong>{{config.advantages.enlightenment.starting}}</strong></p>
          <p class="note">{{i18n 'Wizard.SpherePointsCannotExceedEnlightenment'}}</p>
          <p class="note">{{i18n 'Wizard.CanSpendFreebiesOnEnlightenment' cost=config.freebies.costs.enlightenment}}</p>
        </div>
        
        <div class="enlightenment-purchase">
          <div class="enlightenment-display">
            <span class="enlightenment-label">{{i18n 'Wizard.CurrentEnlightenment'}}:</span>
            <div class="enlightenment-controls">
              <button type="button" class="enlightenment-decrease" {{#if (eq wizardData.advantages.enlightenment config.advantages.enlightenment.starting)}}disabled{{/if}}>
                <i class="fas fa-minus"></i>
              </button>
              <span class="enlightenment-value">{{default wizardData.advantages.enlightenment config.advantages.enlightenment.starting}}</span>
              <button type="button" class="enlightenment-increase" {{#if (or (eq wizardData.advantages.enlightenment config.freebies.limits.enlightenment) (gte wizardData.advantages.freebiesSpent config.freebies.total))}}disabled{{/if}}>
                <i class="fas fa-plus"></i>
              </button>
            </div>
          </div>
          <div class="freebies-spent">
            <span class="freebies-label">{{i18n 'Wizard.FreebiePointsSpentOnEnlightenment'}}:</span>
            <span class="freebies-value">{{default wizardData.advantages.freebiesSpent 0}}</span> / {{config.freebies.total}}
          </div>
        </div>
      </div>
      {{/if}}

      <!-- Spheres (Technocrat and Mage) -->
      {{#if (or (eq actorType "Technocrat") (eq actorType "Mage"))}}
      <div class="advantage-section">
        <h4>{{i18n 'Spheres.Spheres'}} ({{config.advantages.spheres.points}} {{i18n 'Wizard.Points'}})</h4>
        <p class="note sphere-limit-note">{{i18n 'Wizard.YouHaveSpherePoints' points=config.advantages.spheres.points}} {{i18n 'Wizard.NoSphereCanExceedEnlightenment' enlightenment=(default wizardData.advantages.enlightenment config.advantages.enlightenment.starting)}}.</p>
        
        <div class="points-tracker">
          <span class="spent">{{#if validation.spheres}}{{validation.spheres.spent}}{{else}}0{{/if}}</span> / 
          <span class="allowed">{{config.advantages.spheres.points}}</span> {{i18n 'Wizard.PointsSpent'}}
          {{#if validation.spheres}}
          {{#if (gt validation.spheres.remaining 0)}}
          <span class="remaining">({{validation.spheres.remaining}} {{i18n 'Wizard.Remaining'}})</span>
          {{/if}}
          {{else}}
          <span class="remaining">({{config.advantages.spheres.points}} {{i18n 'Wizard.Remaining'}})</span>
          {{/if}}
        </div>
        
        <div class="spheres-list">
          {{#each config.advantages.spheres.available}}
          <div class="sphere-item" data-sphere-key="{{@key}}">
            <span class="sphere-name">{{this}}</span>
            <div class="sphere-controls">
              <button type="button" 
                      class="sphere-decrease" 
                      data-sphere="{{@key}}"
                      {{#if (eq (default (lookup @root.wizardData.advantages.spheres @key) 0) 0)}}disabled{{/if}}>
                <i class="fas fa-minus"></i>
              </button>
              <span class="sphere-value">{{default (lookup @root.wizardData.advantages.spheres @key) 0}}</span>
              <button type="button" 
                      class="sphere-increase" 
                      data-sphere="{{@key}}"
                      {{#if (or (gte (default (lookup @root.wizardData.advantages.spheres @key) 0) (default @root.wizardData.advantages.enlightenment @root.config.advantages.enlightenment.starting)) (and @root.validation.spheres (lte @root.validation.spheres.remaining 0)))}}disabled{{/if}}>
                <i class="fas fa-plus"></i>
              </button>
            </div>
            <div class="sphere-dots">
              {{{renderDots (default (lookup @root.wizardData.advantages.spheres @key) 0) (default @root.wizardData.advantages.enlightenment @root.config.advantages.enlightenment.starting)}}}
            </div>
          </div>
          {{/each}}
        </div>
      </div>
      {{/if}}

      <!-- Willpower -->
      <div class="advantage-section">
        <h4>{{i18n 'Advantages.Willpower'}}</h4>
        <div class="willpower-info">
          <p>{{i18n 'Wizard.StartingWillpower'}}: <strong>{{config.advantages.willpower.starting}}</strong></p>
          <p class="note">{{i18n 'Wizard.CanIncreaseWillpowerWithFreebies'}}</p>
        </div>
      </div>

    </div>
  </div>

  <div class="step-help">
    <div class="help-box">
      <h4><i class="fas fa-lightbulb"></i> {{i18n 'Wizard.AdvantagesGuide'}}</h4>
      <ul>
        <li><strong>{{i18n 'Advantages.Backgrounds'}}:</strong> {{i18n 'Wizard.BackgroundsDescription'}}</li>
        {{#if (or (eq actorType "Technocrat") (eq actorType "Mage"))}}
        <li><strong>{{i18n 'Spheres.Spheres'}}:</strong> {{i18n 'Wizard.SpheresDescription'}}</li>
        <li>{{i18n 'Wizard.MaxSpheresAtCreation' max=config.advantages.spheres.maxAtCreation}}</li>
        {{/if}}
        <li>{{i18n 'Wizard.BackgroundsFitConcept'}}</li>
        <li>{{i18n 'Wizard.MustSpendAll'}}</li>
      </ul>
    </div>
  </div>
</div>

