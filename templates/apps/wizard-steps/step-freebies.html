<div class="wizard-step step-freebies">
  <div class="step-header">
    <h3><i class="fas fa-coins"></i> {{i18n 'Wizard.Freebies'}}</h3>
    <p class="step-description">{{i18n 'Wizard.SpendFreebiePoints'}}</p>
    {{#if (gt wizardData.advantages.freebiesSpent 0)}}
    <p class="note enlightenment-spent-note">
      <i class="fas fa-info-circle"></i> 
      {{i18n 'Wizard.SpentFreebiesOnEnlightenment' spent=wizardData.advantages.freebiesSpent}}
    </p>
    {{/if}}
    {{#if (gt freebieBonus 0)}}
    <p class="note freebie-bonus-note">
      <i class="fas fa-star"></i> 
      {{i18n 'Wizard.GainedExtraFreebiesFromFlaws' bonus=freebieBonus}}
    </p>
    {{/if}}
  </div>

  <div class="step-body">
    <div class="freebies-header">
      <div class="freebies-tracker">
        <div class="freebies-remaining">
          <span class="label">{{i18n 'Wizard.Freebies'}}:</span>
          <span class="value {{#if (lt wizardData.freebies.remaining 0)}}negative{{/if}}">
            {{wizardData.freebies.remaining}} / {{actualFreebieTotal}}
          </span>
          <span class="sublabel">({{i18n 'Common.Remaining'}} / {{i18n 'Wizard.Total'}})</span>
        </div>
        {{#if (gt wizardData.advantages.freebiesSpent 0)}}
        <div class="enlightenment-spent-display">
          <span class="label">{{i18n 'Wizard.SpentOnEnlightenment'}}:</span>
          <span class="value">{{wizardData.advantages.freebiesSpent}}</span>
        </div>
        {{/if}}
      </div>
      
      <div class="freebies-costs">
        <h5>{{i18n 'Wizard.CostsPerDot'}}:</h5>
        <ul>
          <li>{{i18n 'Wizard.Attributes'}}: {{config.freebies.costs.attribute}} {{i18n 'Wizard.Points'}}</li>
          <li>{{i18n 'Wizard.Abilities'}}: {{config.freebies.costs.ability}} {{i18n 'Wizard.Points'}}</li>
          <li>{{i18n 'Advantages.Backgrounds'}}: {{config.freebies.costs.background}} {{i18n 'Wizard.Point'}}</li>
          {{#if (eq actorType "Technocrat")}}
          <li>{{i18n 'Spheres.Spheres'}}: {{config.freebies.costs.sphere}} {{i18n 'Wizard.Points'}}</li>
          <li>{{i18n 'Advantages.Enlightenment'}}: {{config.freebies.costs.enlightenment}} {{i18n 'Wizard.Points'}}</li>
          {{/if}}
          <li>{{i18n 'Advantages.Willpower'}}: {{config.freebies.costs.willpower}} {{i18n 'Wizard.Point'}}</li>
        </ul>
      </div>
    </div>

    <div class="freebies-sections">
      
      <!-- Attributes -->
      <div class="freebie-section">
        <h4>{{i18n 'Wizard.Attributes'}} ({{config.freebies.costs.attribute}} {{i18n 'Wizard.PointsPerDot'}})</h4>
        <div class="freebie-list">
          {{#each wizardData.attributes.values}}
          {{#each this}}
          <div class="freebie-item">
            <span class="item-name">{{capitalize @../key}} - {{@key}}</span>
            <span class="item-current">{{i18n 'Wizard.Current'}}: {{this}}</span>
            <div class="freebie-controls">
              <button type="button" 
                      class="freebie-decrease" 
                      data-type="attribute" 
                      data-target="{{@../key}}.{{@key}}"
                      {{#if (eq this 1)}}disabled{{/if}}>
                <i class="fas fa-minus"></i>
              </button>
              <button type="button" 
                      class="freebie-increase" 
                      data-type="attribute" 
                      data-target="{{@../key}}.{{@key}}"
                      {{#if (eq this 5)}}disabled{{/if}}>
                <i class="fas fa-plus"></i>
              </button>
            </div>
          </div>
          {{/each}}
          {{/each}}
        </div>
      </div>

      <!-- Abilities -->
      <div class="freebie-section">
        <h4>{{i18n 'Wizard.Abilities'}} ({{config.freebies.costs.ability}} {{i18n 'Wizard.PointsPerDot'}})</h4>
        <div class="freebie-list abilities-compact">
          {{#each wizardData.abilities.values}}
          {{#each this}}
          <div class="freebie-item">
            <span class="item-name">{{@key}}</span>
            <span class="item-current">{{i18n 'Wizard.Current'}}: {{default this 0}}</span>
            <div class="freebie-controls">
              <button type="button" 
                      class="freebie-decrease" 
                      data-type="ability" 
                      data-target="{{@../key}}.{{@key}}"
                      {{#if (eq (default this 0) 0)}}disabled{{/if}}>
                <i class="fas fa-minus"></i>
              </button>
              <button type="button" 
                      class="freebie-increase" 
                      data-type="ability" 
                      data-target="{{@../key}}.{{@key}}"
                      {{#if (eq (default this 0) 5)}}disabled{{/if}}>
                <i class="fas fa-plus"></i>
              </button>
            </div>
          </div>
          {{/each}}
          {{/each}}
        </div>
      </div>

      <!-- Backgrounds -->
      <div class="freebie-section">
        <h4>{{i18n 'Advantages.Backgrounds'}} ({{config.freebies.costs.background}} {{i18n 'Wizard.PointPerDot'}})</h4>
        {{#if config.advantages.backgrounds.doubleCost}}
        <p class="note double-cost-note">
          <i class="fas fa-exclamation-triangle"></i>
          <strong>{{#each config.advantages.backgrounds.doubleCost}}{{this}}{{#unless @last}}, {{/unless}}{{/each}}</strong> {{i18n 'Wizard.Cost2PointsPerDot'}}
        </p>
        {{/if}}
        <div class="freebie-list">
          {{#each backgroundsList}}
          {{#unless (eq this "Custom")}}
          {{#with this as |bgName|}}
          {{#if (ne (typeof bgName) "object")}}
          {{#with (findBackgroundValue @root.wizardData.advantages.backgrounds bgName) as |bgValue|}}
          {{#with (findBackgroundIndex @root.wizardData.advantages.backgrounds bgName) as |bgIndex|}}
          <div class="freebie-item" data-background-name="{{bgName}}">
            <span class="item-name">{{bgName}}</span>
            <button type="button" class="background-reference-btn" data-background-name="{{bgName}}" title="{{i18n 'Wizard.ViewBackgroundDetails' name=bgName}}">
              <i class="fas fa-book"></i>
            </button>
            <span class="item-current">{{i18n 'Wizard.Current'}}: {{default bgValue 0}}</span>
            <div class="freebie-controls">
              <button type="button" 
                      class="freebie-decrease" 
                      data-type="background" 
                      data-target="{{bgIndex}}"
                      data-bg-name="{{bgName}}"
                      {{#if (eq bgValue 0)}}disabled{{/if}}>
                <i class="fas fa-minus"></i>
              </button>
              <button type="button" 
                      class="freebie-increase" 
                      data-type="background" 
                      data-target="{{bgIndex}}"
                      data-bg-name="{{bgName}}"
                      {{#if (eq bgValue 5)}}disabled{{/if}}>
                <i class="fas fa-plus"></i>
              </button>
            </div>
          </div>
          {{/with}}
          {{/with}}
          {{/if}}
          {{/with}}
          {{/unless}}
          {{/each}}
        </div>
      </div>

      <!-- Spheres (Technocrat only) -->
      {{#if (eq actorType "Technocrat")}}
      <div class="freebie-section">
        <h4>{{i18n 'Spheres.Spheres'}} ({{config.freebies.costs.sphere}} {{i18n 'Wizard.PointsPerDot'}})</h4>
        <p class="note"><i class="fas fa-info-circle"></i> {{i18n 'Wizard.IndividualSpheresCannotExceedEnlightenment' enlightenment=(default wizardData.advantages.enlightenment config.advantages.enlightenment.starting)}}.</p>
        <div class="freebie-list">
          {{#each config.advantages.spheres.available}}
          <div class="freebie-item">
            <span class="item-name">{{this}}</span>
            <span class="item-current">{{i18n 'Wizard.Current'}}: {{default (lookup @root.wizardData.advantages.spheres @key) 0}}</span>
            <div class="freebie-controls">
              <button type="button" 
                      class="freebie-decrease" 
                      data-type="sphere" 
                      data-target="{{@key}}"
                      {{#if (eq (default (lookup @root.wizardData.advantages.spheres @key) 0) 0)}}disabled{{/if}}>
                <i class="fas fa-minus"></i>
              </button>
              <button type="button" 
                      class="freebie-increase" 
                      data-type="sphere" 
                      data-target="{{@key}}"
                      {{#if (gte (default (lookup @root.wizardData.advantages.spheres @key) 0) (default @root.wizardData.advantages.enlightenment @root.config.advantages.enlightenment.starting))}}disabled{{/if}}>
                <i class="fas fa-plus"></i>
              </button>
            </div>
          </div>
          {{/each}}
        </div>
      </div>

      <!-- Enlightenment (Technocrat only) - Display only, managed in Advantages step -->
      <div class="freebie-section">
        <h4>{{i18n 'Advantages.Enlightenment'}} ({{config.freebies.costs.enlightenment}} {{i18n 'Wizard.PointsPerDot'}})</h4>
        <div class="enlightenment-freebie">
          <p>{{i18n 'Wizard.Current'}}: <strong>{{default wizardData.advantages.enlightenment config.advantages.enlightenment.starting}}</strong></p>
          <p class="note"><i class="fas fa-info-circle"></i> {{i18n 'Wizard.EnlightenmentPurchasedInAdvantages'}}</p>
        </div>
      </div>
      {{/if}}

      <!-- Willpower -->
      <div class="freebie-section">
        <h4>{{i18n 'Advantages.Willpower'}} ({{config.freebies.costs.willpower}} {{i18n 'Wizard.PointPerDot'}})</h4>
        <div class="willpower-freebie">
          <p>{{i18n 'Wizard.Current'}}: <strong>{{add config.advantages.willpower.starting (or wizardData.freebies.spent.willpower 0)}}</strong></p>
          <div class="freebie-controls">
            <button type="button" 
                    class="freebie-decrease" 
                    data-type="willpower" 
                    data-target="willpower"
                    {{#if (eq (or wizardData.freebies.spent.willpower 0) 0)}}disabled{{/if}}>
              <i class="fas fa-minus"></i>
            </button>
            <button type="button" 
                    class="freebie-increase" 
                    data-type="willpower" 
                    data-target="willpower"
                    {{#if (eq (or wizardData.freebies.spent.willpower 0) 10)}}disabled{{/if}}>
              <i class="fas fa-plus"></i>
            </button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <div class="step-help">
    <div class="help-box">
      <h4><i class="fas fa-lightbulb"></i> {{i18n 'Wizard.FreebiePointsGuide'}}</h4>
      <ul>
        <li>{{i18n 'Wizard.YouHaveFreebiePoints' total=actualFreebieTotal}}{{#if (gt freebieBonus 0)}} ({{config.freebies.total}} {{i18n 'Wizard.Base'}} + {{freebieBonus}} {{i18n 'Wizard.FromFlaws'}}){{/if}}</li>
        <li>{{i18n 'Wizard.DontHaveToSpendAll'}}</li>
        <li>{{i18n 'Wizard.ConsiderIncreasing'}}</li>
        <li>{{i18n 'Wizard.WillpowerGoodInvestment'}}</li>
        {{#if (eq actorType "Technocrat")}}
        <li>{{i18n 'Wizard.SpheresExpensiveButPowerful'}}</li>
        {{/if}}
      </ul>
    </div>
  </div>
</div>

